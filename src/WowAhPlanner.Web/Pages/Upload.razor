@page "/upload"
@inject SelectionState Selection
@inject Microsoft.EntityFrameworkCore.IDbContextFactory<WowAhPlanner.Infrastructure.Persistence.AppDbContext> DbFactory

<PageTitle>Upload snapshot</PageTitle>

<h1>Upload AH Snapshot</h1>

<div class="card">
    <h3>Realm</h3>
    <p>Upload will be stored for: <code>@Selection.ToRealmKey()</code></p>
    <p>Provider name used: <span class="badge">UploadedSnapshot</span></p>
    <p>Tip: set <code>Pricing:PrimaryProviderName</code> to <code>UploadedSnapshot</code> in <code>src/WowAhPlanner.Web/appsettings.json</code>.</p>
</div>

<div class="card">
    <h3>Paste JSON</h3>
    <p>Expected schema: <span class="badge">wowahplanner-scan-v1</span></p>
    <textarea @bind="_json" style="width:100%;min-height:220px"></textarea>
    <div style="margin-top:0.75rem">
        <button @onclick="UploadAsync" disabled="@_busy">Upload</button>
    </div>
    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <p>@_message</p>
    }
</div>

@code {
    private string _json = "";
    private string? _message;
    private bool _busy;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await Selection.EnsureLoadedAsync();
        StateHasChanged();
    }

    private async Task UploadAsync()
    {
        _busy = true;
        _message = null;

        try
        {
            var dto = System.Text.Json.JsonSerializer.Deserialize<UploadSnapshotDto>(
                _json,
                new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web));

            if (dto is null)
            {
                _message = "Invalid JSON (null).";
                return;
            }

            if (!string.Equals(dto.Schema, "wowahplanner-scan-v1", StringComparison.OrdinalIgnoreCase))
            {
                _message = $"Unsupported schema '{dto.Schema}'.";
                return;
            }

            if (dto.Prices is null || dto.Prices.Count == 0)
            {
                _message = "No prices[] found.";
                return;
            }

            var snapshotTs = dto.SnapshotTimestampUtc ?? DateTime.UtcNow;
            var realmKey = Selection.ToRealmKey().ToString();
            const string providerName = "UploadedSnapshot";

            await using var db = await DbFactory.CreateDbContextAsync();

            var upserts = 0;
            foreach (var p in dto.Prices)
            {
                if (p.ItemId <= 0) continue;
                if (p.MinUnitBuyoutCopper is null) continue;

                var existing = await db.ItemPriceSummaries.FindAsync([realmKey, providerName, p.ItemId]);
                if (existing is null)
                {
                    db.ItemPriceSummaries.Add(new WowAhPlanner.Infrastructure.Persistence.ItemPriceSummaryEntity
                    {
                        RealmKey = realmKey,
                        ProviderName = providerName,
                        ItemId = p.ItemId,
                        MinBuyoutCopper = p.MinUnitBuyoutCopper.Value,
                        MedianCopper = null,
                        SnapshotTimestampUtc = snapshotTs,
                        CachedAtUtc = DateTime.UtcNow,
                    });
                }
                else
                {
                    existing.MinBuyoutCopper = p.MinUnitBuyoutCopper.Value;
                    existing.MedianCopper = null;
                    existing.SnapshotTimestampUtc = snapshotTs;
                    existing.CachedAtUtc = DateTime.UtcNow;
                }

                upserts++;
            }

            await db.SaveChangesAsync();
            _message = $"Stored {upserts} item prices with snapshot {snapshotTs:u}.";
        }
        catch (Exception ex)
        {
            _message = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private sealed class UploadSnapshotDto
    {
        public string? Schema { get; set; }
        public DateTime? SnapshotTimestampUtc { get; set; }
        public List<PriceDto>? Prices { get; set; }
    }

    private sealed class PriceDto
    {
        public int ItemId { get; set; }
        public long? MinUnitBuyoutCopper { get; set; }
        public long? TotalQuantity { get; set; }
    }
}
