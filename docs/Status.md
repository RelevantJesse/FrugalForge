# Project Status (Jan 2026)

This repo contains **WowAhPlanner** (Blazor Server app) and **WowAhPlannerScan** (in‑game addon) to generate profession leveling plans using real-ish time auction pricing.

## Where we’re at

### Web app
- **Architecture:** `WowAhPlanner.Core` (domain + planner), `WowAhPlanner.Infrastructure` (SQLite EF Core cache + providers + data packs), `WowAhPlanner.Web` (Blazor UI + minimal APIs), `WowAhPlanner.Tests`.
- **Versioned data packs:** `data/{GameVersion}/...` (currently focused on `Anniversary`).
- **Planner supports:**
  - expected-cost-per-skill with orange/yellow/green/gray chances
  - blocks planning with a clear list of missing prices
  - excludes cooldown crafts (`cooldownSeconds > 0`)
  - excludes “blue+ output” recipes when `outputQuality >= 3`
  - vendor reagents use `vendorPriceCopper` and are not scanned or priced from AH
  - intermediates:
    - **Craft intermediates**: expands craftable reagents (e.g., bolts) down to leaf mats
    - **Smelt intermediates**: compares “buy bar” vs “smelt chain” (ore → bar, bar combos like bronze) and chooses cheaper
  - plan output includes: Steps, Intermediates, Shopping List, Totals (formatted g/s/c)
- **Price ingestion:**
  - `UploadedSnapshot` provider (SQLite-backed) for player-uploaded scans
  - `StubJson` provider for deterministic dev/testing
  - caching/fallback tolerance: providers can fail; stale/availability is surfaced in the UI

### Addon (WowAhPlannerScan)
- Targets are generated by the web app and installed to the addon folder.
- Uses legacy AH APIs (`QueryAuctionItems`) and UI-driven search because `C_AuctionHouse` is unavailable on this client.
- Uses **quoted searches** (`"Item Name"`) to force exact name matching on the browse UI.
- Uses **buyout only** (ignores bid-only auctions).
- Uses configurable **nth-cheapest** (default: 3rd) instead of cheapest to reduce outliers.
- Has a small AH panel UI + Settings entry.
- Supports quick one-off scans: `/wahpscan item <itemId|itemLink>`.

## Things we learned (and baked in)
- **Legacy AH querying is rate-limited** and can be slow; `CanSendAuctionQuery` may flip false for long periods. The addon must be patient and back off.
- **Exact matching matters.** Without quotes/exact-match UI, searches return partial-name items (“Thick Leather Ammo Pouch”).
- **Bid-only auctions are misleading for reagent pricing.** Using buyout-only avoids underpricing.
- **Cheapest listing can be an outlier.** The nth-cheapest strategy (default 3rd) is a good “cheap but not insane” heuristic.
- **Intermediates shouldn’t be purchased blindly.** Expanding craftable reagents and (optionally) smelt chains produces more realistic shopping lists.
- **Time-gated crafts must be excluded.** Cooldowns (Mooncloth etc.) can otherwise dominate “cheapest plan” incorrectly.

## Data workflow (current)

1) In web app, select `GameVersion / Region / Realm`.
2) Go to `/targets` and click **Install targets** (writes `WowAhPlannerScan_Targets.lua` into the addon folder).
3) In-game at the AH: click **Scan** or `/wahpscan start`, or scan one item with `/wahpscan item ...`.
4) After scan: `/reload` (so WoW writes SavedVariables).
5) In web app, go to `/upload` and **Import from SavedVariables** (no copy/paste), then upload to SQLite.

## Protecting against bad uploads (current)
- The targets file now embeds `region`, `realmSlug`, and `gameVersion`; the addon includes these fields in exported snapshots.
- Upload UI validates snapshot `(region/version/realmSlug)` against current selection by default and requires an explicit override to accept mismatches.

If this is hosted publicly later: add authentication and/or per-user tokens; JSON metadata validation alone cannot stop intentional spoofing.

## Enhancement ideas (next)

### Near-term
- Better “Intermediates” presentation: group by kind and show underlying reagent expansion (“you will need X ore to smelt Y bars”).
- Owned mats / “already have” inventory deductions.
- Recipe availability sources (trainer/vendor/drop/quest) and UI hints for acquiring missing recipes.
- Smarter pricing heuristics: min/median/trimmed mean, “ignore 1c troll listings”, configurable percentiles.

### Medium-term
- Snapshot history + trend charts per item and per realm.
- Multi-character snapshots (merge scans, show who scanned, when).
- Robust data pack pipeline tooling (repeatable build + validation + provenance).

### Longer-term
- Public hosting model with auth, per-user realms, and signed uploads.
- Automated APIs (TSM/Wowhead/other) as optional providers where licensing/ToS allow.

